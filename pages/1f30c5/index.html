<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>underscore 系列之实现一个模板引擎(下) | Jamey&#39;s</title>
    <meta name="generator" content="VuePress 1.8.0">
    <link rel="stylesheet" href="//at.alicdn.com/t/font_3114978_qe0b39no76.css">
    <link rel="icon" href="/common/avatar.jpg">
    <link rel="stylesheet" href="https://at.alicdn.com/t/font_3077305_pt8umhrn4k9.css">
    <meta name="description" content="web前端技术博客，专注web">
    <meta name="keywords" content="前端博客,个人技术博客,前端,前端开发,前端框架,web前端,前端面试题,技术文档,学习,面试,JavaScript,js,ES6,TypeScript,vue,python,css3,html5,Node,git,github,markdown">
    <meta name="theme-color" content="#11a8cd">
    <meta name="referrer" content="no-referrer-when-downgrade">
    
    <link rel="preload" href="/assets/css/0.styles.958aac5a.css" as="style"><link rel="preload" href="/assets/js/app.8146073e.js" as="script"><link rel="preload" href="/assets/js/2.53e9b62d.js" as="script"><link rel="preload" href="/assets/js/143.3cd454d5.js" as="script"><link rel="preload" href="/assets/js/4.49cfce35.js" as="script"><link rel="prefetch" href="/assets/js/10.769b9eed.js"><link rel="prefetch" href="/assets/js/100.3d61e469.js"><link rel="prefetch" href="/assets/js/101.b9bb39a6.js"><link rel="prefetch" href="/assets/js/102.a11ccded.js"><link rel="prefetch" href="/assets/js/103.7c274fa8.js"><link rel="prefetch" href="/assets/js/104.650aedb6.js"><link rel="prefetch" href="/assets/js/105.a4cbea5b.js"><link rel="prefetch" href="/assets/js/106.e1928a0a.js"><link rel="prefetch" href="/assets/js/107.4a2e0802.js"><link rel="prefetch" href="/assets/js/108.8bcc50d9.js"><link rel="prefetch" href="/assets/js/109.b9159c7d.js"><link rel="prefetch" href="/assets/js/11.e591b5d9.js"><link rel="prefetch" href="/assets/js/110.4cec05a6.js"><link rel="prefetch" href="/assets/js/111.f32d4d03.js"><link rel="prefetch" href="/assets/js/112.15b9ffde.js"><link rel="prefetch" href="/assets/js/113.c9ff09e2.js"><link rel="prefetch" href="/assets/js/114.a8cbe931.js"><link rel="prefetch" href="/assets/js/115.6dde9ccd.js"><link rel="prefetch" href="/assets/js/116.6563faac.js"><link rel="prefetch" href="/assets/js/117.5ab0c13e.js"><link rel="prefetch" href="/assets/js/118.8a978230.js"><link rel="prefetch" href="/assets/js/119.9118f13b.js"><link rel="prefetch" href="/assets/js/12.041edd88.js"><link rel="prefetch" href="/assets/js/120.63dec872.js"><link rel="prefetch" href="/assets/js/121.7012d8ce.js"><link rel="prefetch" href="/assets/js/122.607d43c0.js"><link rel="prefetch" href="/assets/js/123.a2d70b4b.js"><link rel="prefetch" href="/assets/js/124.857e3274.js"><link rel="prefetch" href="/assets/js/125.bd2f7f90.js"><link rel="prefetch" href="/assets/js/126.b18b6a43.js"><link rel="prefetch" href="/assets/js/127.406f6873.js"><link rel="prefetch" href="/assets/js/128.2868ec7b.js"><link rel="prefetch" href="/assets/js/129.a79599f8.js"><link rel="prefetch" href="/assets/js/13.33158654.js"><link rel="prefetch" href="/assets/js/130.885a120a.js"><link rel="prefetch" href="/assets/js/131.17e16215.js"><link rel="prefetch" href="/assets/js/132.7e527a70.js"><link rel="prefetch" href="/assets/js/133.0e272fa0.js"><link rel="prefetch" href="/assets/js/134.eb2f3594.js"><link rel="prefetch" href="/assets/js/135.a319e218.js"><link rel="prefetch" href="/assets/js/136.a8e02c63.js"><link rel="prefetch" href="/assets/js/137.6ad77c20.js"><link rel="prefetch" href="/assets/js/138.cf5afaf2.js"><link rel="prefetch" href="/assets/js/139.33d99d5a.js"><link rel="prefetch" href="/assets/js/14.e5eaf310.js"><link rel="prefetch" href="/assets/js/140.563c3c12.js"><link rel="prefetch" href="/assets/js/141.e6db04c8.js"><link rel="prefetch" href="/assets/js/142.51941014.js"><link rel="prefetch" href="/assets/js/144.05ffe1a0.js"><link rel="prefetch" href="/assets/js/145.09481abe.js"><link rel="prefetch" href="/assets/js/146.b579d331.js"><link rel="prefetch" href="/assets/js/147.79b44127.js"><link rel="prefetch" href="/assets/js/148.b2266540.js"><link rel="prefetch" href="/assets/js/149.5ac78ade.js"><link rel="prefetch" href="/assets/js/15.178bdffd.js"><link rel="prefetch" href="/assets/js/150.5979cddd.js"><link rel="prefetch" href="/assets/js/151.32d3a399.js"><link rel="prefetch" href="/assets/js/152.187f5cf2.js"><link rel="prefetch" href="/assets/js/153.f84d9bb2.js"><link rel="prefetch" href="/assets/js/154.0e600577.js"><link rel="prefetch" href="/assets/js/155.330a651d.js"><link rel="prefetch" href="/assets/js/156.d8c7f098.js"><link rel="prefetch" href="/assets/js/157.81a4e391.js"><link rel="prefetch" href="/assets/js/158.9cf8981f.js"><link rel="prefetch" href="/assets/js/159.efb4fa11.js"><link rel="prefetch" href="/assets/js/16.a6aca1d4.js"><link rel="prefetch" href="/assets/js/160.eacf3c42.js"><link rel="prefetch" href="/assets/js/161.83b46a8e.js"><link rel="prefetch" href="/assets/js/162.237da82b.js"><link rel="prefetch" href="/assets/js/163.e054e907.js"><link rel="prefetch" href="/assets/js/164.43fdbc32.js"><link rel="prefetch" href="/assets/js/165.6a077a76.js"><link rel="prefetch" href="/assets/js/166.95d6286b.js"><link rel="prefetch" href="/assets/js/167.4526921c.js"><link rel="prefetch" href="/assets/js/168.16709438.js"><link rel="prefetch" href="/assets/js/169.febd5060.js"><link rel="prefetch" href="/assets/js/17.93b1dbc2.js"><link rel="prefetch" href="/assets/js/170.ab27a31a.js"><link rel="prefetch" href="/assets/js/171.fb55a1d0.js"><link rel="prefetch" href="/assets/js/172.fd29ba62.js"><link rel="prefetch" href="/assets/js/173.faafef04.js"><link rel="prefetch" href="/assets/js/174.1127a8e6.js"><link rel="prefetch" href="/assets/js/175.4ec5272d.js"><link rel="prefetch" href="/assets/js/176.4540f582.js"><link rel="prefetch" href="/assets/js/177.1f2fb5e8.js"><link rel="prefetch" href="/assets/js/178.a82671a0.js"><link rel="prefetch" href="/assets/js/179.43e3826f.js"><link rel="prefetch" href="/assets/js/18.75d331c3.js"><link rel="prefetch" href="/assets/js/180.1a6a16b6.js"><link rel="prefetch" href="/assets/js/181.12675e08.js"><link rel="prefetch" href="/assets/js/182.7e40c7eb.js"><link rel="prefetch" href="/assets/js/183.f7f67380.js"><link rel="prefetch" href="/assets/js/184.510e39e8.js"><link rel="prefetch" href="/assets/js/185.f4d2d9bc.js"><link rel="prefetch" href="/assets/js/186.f4cff53b.js"><link rel="prefetch" href="/assets/js/187.c1eaebfa.js"><link rel="prefetch" href="/assets/js/188.d8385943.js"><link rel="prefetch" href="/assets/js/189.9adeab37.js"><link rel="prefetch" href="/assets/js/19.157b6ad3.js"><link rel="prefetch" href="/assets/js/190.92f0f375.js"><link rel="prefetch" href="/assets/js/191.db00510b.js"><link rel="prefetch" href="/assets/js/192.110fe12f.js"><link rel="prefetch" href="/assets/js/193.1252ed99.js"><link rel="prefetch" href="/assets/js/194.defe31d1.js"><link rel="prefetch" href="/assets/js/195.b0f650e2.js"><link rel="prefetch" href="/assets/js/196.693c7cf4.js"><link rel="prefetch" href="/assets/js/197.d582570d.js"><link rel="prefetch" href="/assets/js/198.829b95fd.js"><link rel="prefetch" href="/assets/js/199.35d24744.js"><link rel="prefetch" href="/assets/js/20.0fc06484.js"><link rel="prefetch" href="/assets/js/200.2d133918.js"><link rel="prefetch" href="/assets/js/201.66350975.js"><link rel="prefetch" href="/assets/js/202.9f4a3762.js"><link rel="prefetch" href="/assets/js/203.ce448386.js"><link rel="prefetch" href="/assets/js/204.1b6af643.js"><link rel="prefetch" href="/assets/js/205.5e4eda82.js"><link rel="prefetch" href="/assets/js/206.587a8cd6.js"><link rel="prefetch" href="/assets/js/207.825e1fa6.js"><link rel="prefetch" href="/assets/js/208.793c65a5.js"><link rel="prefetch" href="/assets/js/209.15b38f86.js"><link rel="prefetch" href="/assets/js/21.53324fcb.js"><link rel="prefetch" href="/assets/js/210.de8a820b.js"><link rel="prefetch" href="/assets/js/211.7ccc49db.js"><link rel="prefetch" href="/assets/js/212.2157902c.js"><link rel="prefetch" href="/assets/js/213.d8ea0b1c.js"><link rel="prefetch" href="/assets/js/214.6c4f1e9f.js"><link rel="prefetch" href="/assets/js/215.a9969330.js"><link rel="prefetch" href="/assets/js/216.177fc220.js"><link rel="prefetch" href="/assets/js/217.60577727.js"><link rel="prefetch" href="/assets/js/218.a0abb991.js"><link rel="prefetch" href="/assets/js/219.14c9586f.js"><link rel="prefetch" href="/assets/js/22.44066032.js"><link rel="prefetch" href="/assets/js/220.616356af.js"><link rel="prefetch" href="/assets/js/221.6a657001.js"><link rel="prefetch" href="/assets/js/222.9dc4f54f.js"><link rel="prefetch" href="/assets/js/223.7d36005f.js"><link rel="prefetch" href="/assets/js/224.fc60f907.js"><link rel="prefetch" href="/assets/js/225.ba986742.js"><link rel="prefetch" href="/assets/js/226.2b5236e8.js"><link rel="prefetch" href="/assets/js/227.77a6e7f7.js"><link rel="prefetch" href="/assets/js/228.ae8efe1a.js"><link rel="prefetch" href="/assets/js/229.2e41e1e1.js"><link rel="prefetch" href="/assets/js/23.e70f7198.js"><link rel="prefetch" href="/assets/js/230.8102459d.js"><link rel="prefetch" href="/assets/js/231.6605c3fb.js"><link rel="prefetch" href="/assets/js/232.3e8402db.js"><link rel="prefetch" href="/assets/js/233.c460748a.js"><link rel="prefetch" href="/assets/js/234.b385bf4f.js"><link rel="prefetch" href="/assets/js/235.d08ff245.js"><link rel="prefetch" href="/assets/js/236.5c323034.js"><link rel="prefetch" href="/assets/js/237.33075f0d.js"><link rel="prefetch" href="/assets/js/238.dbabc6d7.js"><link rel="prefetch" href="/assets/js/239.7a6da26b.js"><link rel="prefetch" href="/assets/js/24.28edad38.js"><link rel="prefetch" href="/assets/js/240.48188606.js"><link rel="prefetch" href="/assets/js/25.049f013f.js"><link rel="prefetch" href="/assets/js/26.4c11bec2.js"><link rel="prefetch" href="/assets/js/27.19413744.js"><link rel="prefetch" href="/assets/js/28.a561628a.js"><link rel="prefetch" href="/assets/js/29.c8d28c57.js"><link rel="prefetch" href="/assets/js/3.e04e8e9a.js"><link rel="prefetch" href="/assets/js/30.f26ec4ce.js"><link rel="prefetch" href="/assets/js/31.bde7a456.js"><link rel="prefetch" href="/assets/js/32.9d4b7a9e.js"><link rel="prefetch" href="/assets/js/33.84c7b6e6.js"><link rel="prefetch" href="/assets/js/34.07ea45a5.js"><link rel="prefetch" href="/assets/js/35.18dde361.js"><link rel="prefetch" href="/assets/js/36.20340ae0.js"><link rel="prefetch" href="/assets/js/37.0bd6bb12.js"><link rel="prefetch" href="/assets/js/38.91c9bac3.js"><link rel="prefetch" href="/assets/js/39.e5151051.js"><link rel="prefetch" href="/assets/js/40.bc2662b5.js"><link rel="prefetch" href="/assets/js/41.a5d94555.js"><link rel="prefetch" href="/assets/js/42.7bf4d18c.js"><link rel="prefetch" href="/assets/js/43.0e5d47ca.js"><link rel="prefetch" href="/assets/js/44.1d1b5c69.js"><link rel="prefetch" href="/assets/js/45.8cd55664.js"><link rel="prefetch" href="/assets/js/46.99e8beac.js"><link rel="prefetch" href="/assets/js/47.50380303.js"><link rel="prefetch" href="/assets/js/48.1334b1d3.js"><link rel="prefetch" href="/assets/js/49.66b704a6.js"><link rel="prefetch" href="/assets/js/5.4fa51e86.js"><link rel="prefetch" href="/assets/js/50.5ec5cabc.js"><link rel="prefetch" href="/assets/js/51.cd50f5d2.js"><link rel="prefetch" href="/assets/js/52.ef8227ee.js"><link rel="prefetch" href="/assets/js/53.805ec9f3.js"><link rel="prefetch" href="/assets/js/54.25e3cfa4.js"><link rel="prefetch" href="/assets/js/55.ef020600.js"><link rel="prefetch" href="/assets/js/56.8d16cfca.js"><link rel="prefetch" href="/assets/js/57.bdd7ba79.js"><link rel="prefetch" href="/assets/js/58.e6b9b86e.js"><link rel="prefetch" href="/assets/js/59.1a952f6f.js"><link rel="prefetch" href="/assets/js/6.d4d47784.js"><link rel="prefetch" href="/assets/js/60.e45872f8.js"><link rel="prefetch" href="/assets/js/61.b6754a13.js"><link rel="prefetch" href="/assets/js/62.3deede21.js"><link rel="prefetch" href="/assets/js/63.2e787d24.js"><link rel="prefetch" href="/assets/js/64.74bcfe4d.js"><link rel="prefetch" href="/assets/js/65.e09bfce6.js"><link rel="prefetch" href="/assets/js/66.4bb59d35.js"><link rel="prefetch" href="/assets/js/67.e055f87a.js"><link rel="prefetch" href="/assets/js/68.50ce7031.js"><link rel="prefetch" href="/assets/js/69.4f3d070a.js"><link rel="prefetch" href="/assets/js/7.adafd225.js"><link rel="prefetch" href="/assets/js/70.db5efa39.js"><link rel="prefetch" href="/assets/js/71.c0fc0c7a.js"><link rel="prefetch" href="/assets/js/72.f9e2fec5.js"><link rel="prefetch" href="/assets/js/73.b4265543.js"><link rel="prefetch" href="/assets/js/74.53c06c9a.js"><link rel="prefetch" href="/assets/js/75.56b0192f.js"><link rel="prefetch" href="/assets/js/76.1b2c28f5.js"><link rel="prefetch" href="/assets/js/77.76951f00.js"><link rel="prefetch" href="/assets/js/78.12467512.js"><link rel="prefetch" href="/assets/js/79.920d7a32.js"><link rel="prefetch" href="/assets/js/8.e9c1fc77.js"><link rel="prefetch" href="/assets/js/80.096fc605.js"><link rel="prefetch" href="/assets/js/81.2d15ceec.js"><link rel="prefetch" href="/assets/js/82.f6589a2c.js"><link rel="prefetch" href="/assets/js/83.df1058c6.js"><link rel="prefetch" href="/assets/js/84.23f44791.js"><link rel="prefetch" href="/assets/js/85.3bfe5699.js"><link rel="prefetch" href="/assets/js/86.399dfc97.js"><link rel="prefetch" href="/assets/js/87.a924e401.js"><link rel="prefetch" href="/assets/js/88.08ce7ee8.js"><link rel="prefetch" href="/assets/js/89.f5918d63.js"><link rel="prefetch" href="/assets/js/9.6f856bc0.js"><link rel="prefetch" href="/assets/js/90.88af4054.js"><link rel="prefetch" href="/assets/js/91.1b3fbc53.js"><link rel="prefetch" href="/assets/js/92.8177c6d9.js"><link rel="prefetch" href="/assets/js/93.52710f7f.js"><link rel="prefetch" href="/assets/js/94.02f77878.js"><link rel="prefetch" href="/assets/js/95.ff80e3bf.js"><link rel="prefetch" href="/assets/js/96.e272b810.js"><link rel="prefetch" href="/assets/js/97.c203eb54.js"><link rel="prefetch" href="/assets/js/98.b02d35be.js"><link rel="prefetch" href="/assets/js/99.135710a8.js">
    <link rel="stylesheet" href="/assets/css/0.styles.958aac5a.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/common/avatar.jpg" alt="Jamey's" class="logo"> <span class="site-name can-hide">Jamey's</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/navigation/" class="nav-link">导航站</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端" class="dropdown-title"><a href="/web/" class="link-title">前端</a> <span class="title" style="display:none;">前端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>学习专栏</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/note/html/" class="nav-link">《HTML》笔记</a></li><li class="dropdown-subitem"><a href="/note/css/" class="nav-link">《CSS》笔记</a></li><li class="dropdown-subitem"><a href="/note/javascript/" class="nav-link">《JavaScript》笔记</a></li><li class="dropdown-subitem"><a href="/note/vue/" class="nav-link">《Vue》笔记</a></li><li class="dropdown-subitem"><a href="/note/git/" class="nav-link">《Git》笔记</a></li><li class="dropdown-subitem"><a href="/note/specification/" class="nav-link">《规范》笔记</a></li><li class="dropdown-subitem"><a href="/note/softSkill/" class="nav-link">《软技能》笔记</a></li><li class="dropdown-subitem"><a href="/note/interview/" class="nav-link">《面试》笔记</a></li><li class="dropdown-subitem"><a href="/note/continuousDelivery/" class="nav-link">《持续集成&amp;交付&amp;部署》笔记</a></li></ul></li><li class="dropdown-item"><h4>踩坑专栏</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/note/element-ui/" class="nav-link">《Element-UI 实践系列》笔记</a></li><li class="dropdown-subitem"><a href="/note/mobile/" class="nav-link">《移动端 实践系列》笔记</a></li><li class="dropdown-subitem"><a href="/note/complex/" class="nav-link">《综合》笔记</a></li></ul></li><li class="dropdown-item"><h4>配置专栏</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/node/environment/" class="nav-link">《环境系列》笔记</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="NAS" class="dropdown-title"><a href="/nas/" class="link-title">NAS</a> <span class="title" style="display:none;">NAS</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>极空间</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/note/nas/" class="nav-link">Docker</a></li></ul></li><li class="dropdown-item"><h4>影视</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/note/movie/" class="nav-link">movie</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="其他" class="dropdown-title"><a href="/comprehensive/" class="link-title">其他</a> <span class="title" style="display:none;">其他</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>编辑器笔记</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/note/idea/" class="nav-link">开发编辑器</a></li></ul></li><li class="dropdown-item"><h4>浏览器笔记</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/note/browser/" class="nav-link">Chrome</a></li></ul></li><li class="dropdown-item"><h4>Mac笔记</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/note/mac/" class="nav-link">Mac</a></li></ul></li><li class="dropdown-item"><h4>跨界学习</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/note/cross-border/" class="nav-link">运营</a></li></ul></li><li class="dropdown-item"><h4>破解合集</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/note/cracked/" class="nav-link">破解</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>本站</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-subitem"><a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-subitem"><a href="/archives/" class="nav-link">归档</a></li></ul></li><li class="dropdown-item"><h4>我的</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/whell/web/" class="nav-link">收藏</a></li><li class="dropdown-subitem"><a href="/whell/book/" class="nav-link">书单</a></li><li class="dropdown-subitem"><a href="/about/" class="nav-link">关于</a></li></ul></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="/common/avatar.jpg"> <div class="blogger-info"><h3>Jamey</h3> <span></span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/navigation/" class="nav-link">导航站</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端" class="dropdown-title"><a href="/web/" class="link-title">前端</a> <span class="title" style="display:none;">前端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>学习专栏</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/note/html/" class="nav-link">《HTML》笔记</a></li><li class="dropdown-subitem"><a href="/note/css/" class="nav-link">《CSS》笔记</a></li><li class="dropdown-subitem"><a href="/note/javascript/" class="nav-link">《JavaScript》笔记</a></li><li class="dropdown-subitem"><a href="/note/vue/" class="nav-link">《Vue》笔记</a></li><li class="dropdown-subitem"><a href="/note/git/" class="nav-link">《Git》笔记</a></li><li class="dropdown-subitem"><a href="/note/specification/" class="nav-link">《规范》笔记</a></li><li class="dropdown-subitem"><a href="/note/softSkill/" class="nav-link">《软技能》笔记</a></li><li class="dropdown-subitem"><a href="/note/interview/" class="nav-link">《面试》笔记</a></li><li class="dropdown-subitem"><a href="/note/continuousDelivery/" class="nav-link">《持续集成&amp;交付&amp;部署》笔记</a></li></ul></li><li class="dropdown-item"><h4>踩坑专栏</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/note/element-ui/" class="nav-link">《Element-UI 实践系列》笔记</a></li><li class="dropdown-subitem"><a href="/note/mobile/" class="nav-link">《移动端 实践系列》笔记</a></li><li class="dropdown-subitem"><a href="/note/complex/" class="nav-link">《综合》笔记</a></li></ul></li><li class="dropdown-item"><h4>配置专栏</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/node/environment/" class="nav-link">《环境系列》笔记</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="NAS" class="dropdown-title"><a href="/nas/" class="link-title">NAS</a> <span class="title" style="display:none;">NAS</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>极空间</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/note/nas/" class="nav-link">Docker</a></li></ul></li><li class="dropdown-item"><h4>影视</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/note/movie/" class="nav-link">movie</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="其他" class="dropdown-title"><a href="/comprehensive/" class="link-title">其他</a> <span class="title" style="display:none;">其他</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>编辑器笔记</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/note/idea/" class="nav-link">开发编辑器</a></li></ul></li><li class="dropdown-item"><h4>浏览器笔记</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/note/browser/" class="nav-link">Chrome</a></li></ul></li><li class="dropdown-item"><h4>Mac笔记</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/note/mac/" class="nav-link">Mac</a></li></ul></li><li class="dropdown-item"><h4>跨界学习</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/note/cross-border/" class="nav-link">运营</a></li></ul></li><li class="dropdown-item"><h4>破解合集</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/note/cracked/" class="nav-link">破解</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>本站</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-subitem"><a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-subitem"><a href="/archives/" class="nav-link">归档</a></li></ul></li><li class="dropdown-item"><h4>我的</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/whell/web/" class="nav-link">收藏</a></li><li class="dropdown-subitem"><a href="/whell/book/" class="nav-link">书单</a></li><li class="dropdown-subitem"><a href="/about/" class="nav-link">关于</a></li></ul></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>深入系列</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>专题系列</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>underscore系列</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/5a58ac/" class="sidebar-link">underscore 系列之如何写自己的 underscore</a></li><li><a href="/pages/ad7318/" class="sidebar-link">underscore 系列之链式调用</a></li><li><a href="/pages/ccc62b/" class="sidebar-link">underscore 系列之内部函数 cb 和 optimizeCb</a></li><li><a href="/pages/9fe123/" class="sidebar-link">underscore 系列之内部函数 restArgs</a></li><li><a href="/pages/01f70e/" class="sidebar-link">underscore 系列之防冲突与 Utility Functions</a></li><li><a href="/pages/5d25f3/" class="sidebar-link">underscore 系列之实现一个模板引擎(上)</a></li><li><a href="/pages/1f30c5/" aria-current="page" class="active sidebar-link">underscore 系列之实现一个模板引擎(下)</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/pages/1f30c5/#📖-前言" class="sidebar-link">📖. 前言</a></li><li class="sidebar-sub-header level2"><a href="/pages/1f30c5/#一-反斜杠的作用" class="sidebar-link">一. 反斜杠的作用</a></li><li class="sidebar-sub-header level2"><a href="/pages/1f30c5/#二-转义序列" class="sidebar-link">二. 转义序列</a></li><li class="sidebar-sub-header level2"><a href="/pages/1f30c5/#三-line-terminators" class="sidebar-link">三. Line Terminators</a></li><li class="sidebar-sub-header level2"><a href="/pages/1f30c5/#四-function" class="sidebar-link">四. Function</a></li><li class="sidebar-sub-header level2"><a href="/pages/1f30c5/#五-特殊字符" class="sidebar-link">五. 特殊字符</a></li><li class="sidebar-sub-header level2"><a href="/pages/1f30c5/#六-replace" class="sidebar-link">六. replace</a></li><li class="sidebar-sub-header level2"><a href="/pages/1f30c5/#七-正则表达式的创建" class="sidebar-link">七. 正则表达式的创建</a></li><li class="sidebar-sub-header level2"><a href="/pages/1f30c5/#八-正则表达式的特殊字符" class="sidebar-link">八. 正则表达式的特殊字符</a></li><li class="sidebar-sub-header level2"><a href="/pages/1f30c5/#九-惰性匹配" class="sidebar-link">九. 惰性匹配</a></li><li class="sidebar-sub-header level2"><a href="/pages/1f30c5/#十-template" class="sidebar-link">十. template</a></li><li class="sidebar-sub-header level2"><a href="/pages/1f30c5/#十一-第五版-特殊字符的处理" class="sidebar-link">十一. 第五版 - 特殊字符的处理</a></li><li class="sidebar-sub-header level2"><a href="/pages/1f30c5/#十二-第六版-特殊值的处理" class="sidebar-link">十二. 第六版 - 特殊值的处理</a></li><li class="sidebar-sub-header level2"><a href="/pages/1f30c5/#十三-第七版" class="sidebar-link">十三. 第七版</a></li><li class="sidebar-sub-header level2"><a href="/pages/1f30c5/#十四-最终版" class="sidebar-link">十四. 最终版</a></li></ul></li><li><a href="/pages/f7e68a/" class="sidebar-link">underscore 系列之字符实体与 _.escape</a></li><li><a href="/pages/e240bf/" class="sidebar-link">underscore 的源码该如何阅读？</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>ES6系列</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>模块化</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>正则表达式</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>单元测试</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>微前端</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>实用函数</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Rollup</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>解决方案</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><a href="/note/javascript/#《JavaScript》笔记" data-v-06225672>《JavaScript》笔记</a></li><li data-v-06225672><a href="/note/javascript/#underscore系列" data-v-06225672>underscore系列</a></li></ul> <div class="info" data-v-06225672><div title="作者" class="author iconfont icon-touxiang" data-v-06225672><a href="javascript:;" data-v-06225672>Jamey</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2021-11-15</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABKFJREFUSA3tVl1oFVcQnrMbrak3QUgkya1akpJYcrUtIqW1JvFBE9LiQ5v6JmJpolbMg32rVrhgoYK0QiMY6i9Y6EMaW5D+xFJaTYItIuK2Kr3+BJNwkxBj05sQY3b3nM6cs2dv9t7NT/vQJw/sndk5M/PNzJkzewGerP+pAmy+ON8lLzUJgA8ZYxYIYZmGYRnctDaWvJJAmTtfP1pvXsBCCPP8QFcCaRkZYACgDZFO4stNIcBCajEOlmmC9XpJ9bAGCaPaPmzPl32dvLSVu3BWCTQs0XQQ6g0DYgwLIoAZbBCdW/i+781o1VVlm/410mw4h06Y7bIPHNyWDyL4FHkX03Q8SrzNhZTZriieckWt7cL6MM85YcLpsi/7O9/iXFT6MswI0DmmpkSaJ0qLxFIm3+i1THHB3zmBH3PYx9CcykcLOeQVVa7QtdxTgQgEleX2AjHYfwA+2ddV77ruGoJUbhGDI09YSNXyMpUt5ylOzxgbUmtOp7NmbNt8v3arjTBfYELmLUV+M+nSawNNAUqpT3ClJWg5I3BLT+cGW/DXNGCa6tx1aakCGEigArTn4TDIPdrXXYKCZNrHLMCOEPvHBlLQ99s9eHB7EB6NTki73CVPQ2F5MSx/uRQixfmq7rK0wYD8w8E905bnPDfwoWs/rfv93NWN/ZfvwsLIU7A09gxECyISeGJkHAau98L97tuw7NXnoPyNF8FcYGLGKsOs0mN3OEyec9esGW/ZEl945dTP34wlR2FZVQWU1q0Cw8Tr7p+hgLLNL0FPxx/Q35mA8aEUrH6nCgwEl0tn7wUiZYJnNRh6DK4UH/k0lfyrsBKdPVv/AriGIQcEDQZ65LBAGe2Rzui9Ybjz7XUppz1/uKBbyVPGkN3ZAeC6hr0x7Nr38N5+EqkoOm17xpoqR9ohQF55ERSvr4Dkr3chNfC3DMzGJlNBElW8w9nsGQvhNGIzDkXzCg8cLK951xHsFBlTJspJNi3ZFIMF2AeDV3q8DNOB+YHi6QTrChDIWDBRi5U5f+ZMfJLu3ccrqxtdxk4SKH336LFxSmkqefwU5T8fhdSdQf9IVKD6aNiwI/hnmcAZ91isYMJIaCUCx9W098+LgruikeTqzqqxKPUwqJyCPJiyemVVZBOijDGjD38Os0jOiSPL1z3SPjXNANbiNPXAdzTfukjjuknNBbyz3nwgTd3AVFqUJ5hpHlq9MveLnWwttUfoygBmvVjuikxND3znrhsELnZk7k+OjIGxeNEkomyLVta0xxn+HZhjBc4YZ/AFjHjz9u3xRZl2BN4aq9nFwWh16IrQ1aHHEd3j1+4/dB9OtH4e29A2H1DyHQRmOSfQZ1Fy7MHBTGB6J/Djq6p3OxyO2cB+4Car7v/o3GXgfAkj23+x9ID1Teoamo/SXcbvSf2PX7Vc8DdCmE1vN9di+32P9/5YR3vLnhCVGUWBjEkr3yh4H8v9CzmsbdhzOKzsJKM90iFdaTMjRPhGVsakRvOaRidljo6H6G7j+ctrJpsP+4COhDIl0La2+FS4+5mlocBaXY5QnGZysIBYoeSsl5qQzrSj/cgNrfuEzlWBfwA+EjrZyWUvpAAAAABJRU5ErkJggg==">underscore 系列之实现一个模板引擎(下)<!----></h1> <!----> <div class="theme-vdoing-content content__default"><h1 id="underscore-系列之实现一个模板引擎-下"><a href="#underscore-系列之实现一个模板引擎-下" class="header-anchor">#</a> underscore 系列之实现一个模板引擎(下)</h1> <h2 id="📖-前言"><a href="#📖-前言" class="header-anchor">#</a> 📖. 前言</h2> <p>本篇接着上篇 <a href="/《JavaScript》笔记/03.underscore系列/06.underscore系列之实现一个模板引擎-上.html">《underscore 系列之实现一个模板引擎(上)》</a></p> <p>鉴于本篇涉及的知识点太多，我们先来介绍下会用到的知识点。</p> <h2 id="一-反斜杠的作用"><a href="#一-反斜杠的作用" class="header-anchor">#</a> 一. 反斜杠的作用</h2> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> txt <span class="token operator">=</span> <span class="token string">&quot;We are the so-called &quot;</span>Vikings<span class="token string">&quot; from the north.&quot;</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>txt<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>我们的本意是想打印带 <code>&quot;&quot;</code> 包裹的 <code>Vikings</code> 字符串，但是在 JavaScript 中，字符串使用单引号或者双引号来表示起始或者结束，这段代码会报 <code>Unexpected identifier</code> 错误。</p> <p>如果我们就是想要在字符串中使用单引号或者双引号呢？</p> <p>我们可以使用反斜杠用来在文本字符串中插入省略号、换行符、引号和其他特殊字符：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> txt <span class="token operator">=</span> <span class="token string">&quot;We are the so-called \&quot;Vikings\&quot; from the north.&quot;</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>txt<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>现在 JavaScript 就可以输出正确的文本字符串了。</p> <p><strong>这种由反斜杠后接字母或数字组合构成的字符组合就叫做“转义序列”。</strong></p> <p>值得注意的是，转义序列会被视为单个字符。</p> <p>我们常见的转义序列还有 <code>\n</code> 表示换行、<code>\t</code> 表示制表符、<code>\r</code> 表示回车等等。</p> <h2 id="二-转义序列"><a href="#二-转义序列" class="header-anchor">#</a> 二. 转义序列</h2> <p>在 JavaScript 中，字符串值是一个由零或多个 Unicode 字符（字母、数字和其他字符）组成的序列。</p> <p>字符串中的每个字符均可由一个转义序列表示。比如字母 <code>a</code>，也可以用转义序列 <code>\u0061</code> 表示。</p> <blockquote><p>转义序列以反斜杠 <code>\</code> 开头，它的作用是告知 JavaScript 解释器下一个字符是特殊字符。</p></blockquote> <blockquote><p>转义序列的语法为 <code>\uhhhh</code>，其中 hhhh 是四位十六进制数。</p></blockquote> <p>根据这个规则，我们可以算出常见字符的转义序列，以字母 <code>m</code> 为例：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 1. 求出字符 `m` 对应的 unicode 值</span>
<span class="token keyword">var</span> unicode <span class="token operator">=</span> <span class="token string">'m'</span><span class="token punctuation">.</span><span class="token function">charCodeAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 109</span>
<span class="token comment">// 2. 转成十六进制</span>
<span class="token keyword">var</span> result <span class="token operator">=</span> unicode<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &quot;6d&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>我们就可以使用 <code>\u006d</code> 表示 <code>m</code>，不信你可以直接在浏览器命令行中直接输入字符串 <code>'\u006d'</code>，看下打印结果。</p> <p>值得注意的是: <code>\n</code> 虽然也是一种转义序列，但是也可以使用上面的方式：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> unicode <span class="token operator">=</span> <span class="token string">'\n'</span><span class="token punctuation">.</span><span class="token function">charCodeAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 10</span>
<span class="token keyword">var</span> result <span class="token operator">=</span> unicode<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &quot;a&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>所以我们可以用 <code>\u000A</code> 来表示换行符 <code>\n</code>，比如在浏览器命令行中直接输入 <code>'a \n b'</code> 和 <code>'a \u000A b'</code> 效果是一样的。</p> <p>讲了这么多，我们来看看一些常用字符的转义序列以及含义：</p> <table><thead><tr><th style="text-align:left;">Unicode 字符值</th> <th style="text-align:left;">转义序列</th> <th style="text-align:left;">含义</th></tr></thead> <tbody><tr><td style="text-align:left;">\u0009</td> <td style="text-align:left;">\t</td> <td style="text-align:left;">制表符</td></tr> <tr><td style="text-align:left;">\u000A</td> <td style="text-align:left;">\n</td> <td style="text-align:left;">换行</td></tr> <tr><td style="text-align:left;">\u000D</td> <td style="text-align:left;">\r</td> <td style="text-align:left;">回车</td></tr> <tr><td style="text-align:left;">\u0022</td> <td style="text-align:left;">&quot;</td> <td style="text-align:left;">双引号</td></tr> <tr><td style="text-align:left;">\u0027</td> <td style="text-align:left;">'</td> <td style="text-align:left;">单引号</td></tr> <tr><td style="text-align:left;">\u005C</td> <td style="text-align:left;">\</td> <td style="text-align:left;">反斜杠</td></tr> <tr><td style="text-align:left;">\u2028</td> <td style="text-align:left;"></td> <td style="text-align:left;">行分隔符</td></tr> <tr><td style="text-align:left;">\u2029</td> <td style="text-align:left;"></td> <td style="text-align:left;">段落分隔符</td></tr></tbody></table> <h2 id="三-line-terminators"><a href="#三-line-terminators" class="header-anchor">#</a> 三. Line Terminators</h2> <p>Line Terminators，中文译文 <code>行终结符</code>。像空白字符一样，<code>行终结符</code> 可用于改善源文本的可读性。</p> <p>在 ES5 中，有四个字符被认为是 <code>行终结符</code>，其他的折行字符都会被视为空白。</p> <p>这四个字符如下所示：</p> <table><thead><tr><th style="text-align:left;">字符编码值</th> <th style="text-align:left;">名称</th></tr></thead> <tbody><tr><td style="text-align:left;">\u000A</td> <td style="text-align:left;">换行符</td></tr> <tr><td style="text-align:left;">\u000D</td> <td style="text-align:left;">回车符</td></tr> <tr><td style="text-align:left;">\u2028</td> <td style="text-align:left;">行分隔符</td></tr> <tr><td style="text-align:left;">\u2029</td> <td style="text-align:left;">段落分隔符</td></tr></tbody></table> <h2 id="四-function"><a href="#四-function" class="header-anchor">#</a> 四. Function</h2> <p>试想我们写这样一段代码，能否正确运行：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> log <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Function</span><span class="token punctuation">(</span><span class="token string">&quot;var a = '1\t23';console.log(a)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>答案是可以，那下面这段呢：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> log <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Function</span><span class="token punctuation">(</span><span class="token string">&quot;var a = '1\n23';console.log(a)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>答案是不可以，会报错 <code>Uncaught SyntaxError: Invalid or unexpected token</code>。</p> <p>这是为什么呢？</p> <p>这是因为在 Function 构造函数的实现中，首先会将函数体代码字符串进行一次 <code>ToString</code> 操作，这时候字符串变成了：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>var a = '1
23';console.log(a)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>然后再检测代码字符串是否符合代码规范，在 JavaScript 中，<strong>字符串表达式中是不允许换行的</strong>，这就导致了报错。</p> <p>为了避免这个问题，我们需要将代码修改为：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> log <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Function</span><span class="token punctuation">(</span><span class="token string">&quot;var a = '1\\n23';console.log(a)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>其实不止 <code>\n</code>，其他三种 <code>行终结符</code>，如果你在字符串表达式中直接使用，都会导致报错！</p> <p>之所以讲这个问题，是因为在模板引擎的实现中，就是使用了 Function 构造函数，如果我们在模板字符串中使用了 <code>行终结符</code>，便有可能会出现一样的错误，所以我们必须要对这四种 <code>行终结符</code> 进行特殊的处理。</p> <h2 id="五-特殊字符"><a href="#五-特殊字符" class="header-anchor">#</a> 五. 特殊字符</h2> <p>除了这四种 <code>行终结符</code> 之外，我们还要对两个字符进行处理。</p> <p>一个是 <code>\</code>。</p> <p>比如说我们的模板内容中使用了 <code>\</code>:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> log <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Function</span><span class="token punctuation">(</span><span class="token string">&quot;var a = '1\23';console.log(a)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>其实我们是想打印 <code>'1\23'</code>，但是因为把 <code>\</code> 当成了特殊字符的标记进行处理，所以最终打印了 1。</p> <p>同样的道理，如果我们在使用模板引擎的时候，使用了 <code>\</code> 字符串，也会导致错误的处理。</p> <p>第二个是 <code>'</code>。</p> <p>如果我们在模板引擎中使用了 <code>'</code>，因为我们会拼接诸如 <code>p.push(' ')</code> 等字符串，因为 <code>'</code> 的原因，字符串会被错误拼接，也会导致错误。</p> <p>所以总共我们需要对六种字符进行特殊处理，处理的方式，就是正则匹配出这些特殊字符，然后比如将 <code>\n</code> 替换成 <code>\\n</code>，<code>\</code> 替换成 <code>\\</code>，<code>'</code> 替换成 <code>\\'</code>，处理的代码为：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> escapes <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string-property property">&quot;'&quot;</span><span class="token operator">:</span> <span class="token string">&quot;'&quot;</span><span class="token punctuation">,</span>
    <span class="token string-property property">'\\'</span><span class="token operator">:</span> <span class="token string">'\\'</span><span class="token punctuation">,</span>
    <span class="token string-property property">'\r'</span><span class="token operator">:</span> <span class="token string">'r'</span><span class="token punctuation">,</span>
    <span class="token string-property property">'\n'</span><span class="token operator">:</span> <span class="token string">'n'</span><span class="token punctuation">,</span>
    <span class="token string-property property">'\u2028'</span><span class="token operator">:</span> <span class="token string">'u2028'</span><span class="token punctuation">,</span>
    <span class="token string-property property">'\u2029'</span><span class="token operator">:</span> <span class="token string">'u2029'</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> escapeRegExp <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\\|'|\r|\n|\u2028|\u2029</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">;</span>

<span class="token keyword">var</span> <span class="token function-variable function">escapeChar</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">match</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">'\\'</span> <span class="token operator">+</span> escapes<span class="token punctuation">[</span>match<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>我们测试一下：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> str <span class="token operator">=</span> <span class="token string">'console.log(&quot;I am \n Kevin&quot;);'</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> newStr <span class="token operator">=</span> str<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>escapeRegExp<span class="token punctuation">,</span> escapeChar<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">eval</span><span class="token punctuation">(</span>newStr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// I am </span>
<span class="token comment">// Kevin</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h2 id="六-replace"><a href="#六-replace" class="header-anchor">#</a> 六. replace</h2> <p>我们来讲一讲字符串的 replace 函数：</p> <p>语法为：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>str<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>regexp<span class="token operator">|</span>substr<span class="token punctuation">,</span> newSubStr<span class="token operator">|</span><span class="token keyword">function</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>replace 的第一个参数，可以传一个字符串，也可以传一个正则表达式。</p> <p>第二个参数，可以传一个新字符串，也可以传一个函数。</p> <p>我们重点看下传入函数的情况，简单举一个例子：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> str <span class="token operator">=</span> <span class="token string">'hello world'</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> newStr <span class="token operator">=</span> str<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">'world'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">match</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">return</span> match <span class="token operator">+</span> <span class="token string">'!'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>newStr<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// hello world!</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>match 表示匹配到的字符串，但函数的参数其实不止有 match，我们看个更复杂的例子：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">replacer</span><span class="token punctuation">(</span><span class="token parameter">match<span class="token punctuation">,</span> p1<span class="token punctuation">,</span> p2<span class="token punctuation">,</span> p3<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// match，表示匹配的子串 abc12345#$*%</span>
    <span class="token comment">// p1，第 1 个括号匹配的字符串 abc</span>
    <span class="token comment">// p2，第 2 个括号匹配的字符串 12345</span>
    <span class="token comment">// p3，第 3 个括号匹配的字符串 #$*%</span>
    <span class="token comment">// offset，匹配到的子字符串在原字符串中的偏移量 0</span>
    <span class="token comment">// string，被匹配的原字符串 abc12345#$*%</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span>p1<span class="token punctuation">,</span> p2<span class="token punctuation">,</span> p3<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">' - '</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> newString <span class="token operator">=</span> <span class="token string">'abc12345#$*%'</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">([^\d]*)(\d*)([^\w]*)</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> replacer<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// abc - 12345 - #$*%</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>另外要注意的是，如果第一个参数是正则表达式，并且其为全局匹配模式， 那么这个方法将被多次调用，每次匹配都会被调用。</p> <p>举个例子，如果我们要在一段字符串中匹配出 <code>&lt;%=xxx%&gt;</code> 中的值：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> str <span class="token operator">=</span> <span class="token string">'&lt;li&gt;&lt;a href=&quot;&lt;%=www.baidu.com%&gt;&quot;&gt;&lt;%=baidu%&gt;&lt;/a&gt;&lt;/li&gt;'</span>

str<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">&lt;%=(.+?)%&gt;</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">match<span class="token punctuation">,</span> p1<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> string</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>match<span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>p1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>string<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>传入的函数会被执行两次，第一次的打印结果为：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>&lt;%=www.baidu.com%&gt;
www.baidu.com
13
&lt;li&gt;&lt;a href=&quot;&lt;%=www.baidu.com%&gt;&quot;&gt;&lt;%=baidu%&gt;&lt;/a&gt;&lt;/li&gt;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>第二次的打印结果为：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>&lt;%=baidu%&gt;
'baidu'
33
&lt;li&gt;&lt;a href=&quot;&lt;%=www.baidu.com%&gt;&quot;&gt;&lt;%=baidu%&gt;&lt;/a&gt;&lt;/li&gt;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h2 id="七-正则表达式的创建"><a href="#七-正则表达式的创建" class="header-anchor">#</a> 七. 正则表达式的创建</h2> <p>当我们要建立一个正则表达式的时候，我们可以直接创建：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> reg <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">ab+c</span><span class="token regex-delimiter">/</span><span class="token regex-flags">i</span></span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>也可以使用构造函数的方式：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token string">'ab+c'</span><span class="token punctuation">,</span> <span class="token string">'i'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>值得一提的是：每个正则表达式对象都有一个 source 属性，返回当前正则表达式对象的模式文本的字符串：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> regex <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">fooBar</span><span class="token regex-delimiter">/</span><span class="token regex-flags">ig</span></span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>regex<span class="token punctuation">.</span>source<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &quot;fooBar&quot;，不包含 /.../ 和 &quot;ig&quot;。</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h2 id="八-正则表达式的特殊字符"><a href="#八-正则表达式的特殊字符" class="header-anchor">#</a> 八. 正则表达式的特殊字符</h2> <p>正则表达式中有一些特殊字符，比如 <code>\d</code> 就表示了匹配一个数字，等价于 [0-9]。</p> <p>在上节，我们使用 <code>/&lt;%=(.+?)%&gt;/g</code> 来匹配 <code>&lt;%=xxx%&gt;</code>，然而在 underscore 的实现中，用的却是 <code>/&lt;%=([\s\S]+?)%&gt;/g</code>。</p> <p>我们知道 \s 表示匹配一个空白符，包括空格、制表符、换页符、换行符和其他 Unicode 空格，\S
匹配一个非空白符，[\s\S]就表示匹配所有的内容，可是为什么我们不直接使用 <code>.</code> 呢？</p> <p>我们可能以为 <code>.</code> 匹配任意单个字符，实际上，并不是如此， <code>.</code> 匹配除 <code>行终结符</code> 之外的任何单个字符，不信我们做个试验：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> str <span class="token operator">=</span> <span class="token string">'&lt;%=hello world%&gt;'</span><span class="token punctuation">;</span>

str<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">&lt;%=(.+?)%&gt;</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">match</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>match<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &lt;%=hello world%&gt;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>但是如果我们在 hello world 之间加上一个 <code>行终结符</code>，比如说 <code>'\u2029'</code>：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> str <span class="token operator">=</span> <span class="token string">'&lt;%=hello \u2029 world%&gt;'</span><span class="token punctuation">;</span>

str<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">&lt;%=(.+?)%&gt;</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">match</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>match<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>因为匹配不到，所以也不会执行 console.log 函数。</p> <p>但是改成 <code>/&lt;%=([\s\S]+?)%&gt;/g</code> 就可以正常匹配：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> str <span class="token operator">=</span> <span class="token string">'&lt;%=hello \u2029 world%&gt;'</span><span class="token punctuation">;</span>

str<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">&lt;%=([\s\S]+?)%&gt;</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">match</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>match<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &lt;%=hello world%&gt;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h2 id="九-惰性匹配"><a href="#九-惰性匹配" class="header-anchor">#</a> 九. 惰性匹配</h2> <p>仔细看 <code>/&lt;%=([\s\S]+?)%&gt;/g</code> 这个正则表达式，我们知道 <code>x+</code> 表示匹配 <code>x</code> 1 次或多次。<code>x?</code> 表示匹配 <code>x</code> 0 次或 1 次，但是 <code>+?</code> 是个什么鬼？</p> <p>实际上，如果在数量词 *、+、? 或 {}, 任意一个后面紧跟该符号（?），会使数量词变为非贪婪（ non-greedy） ，即匹配次数最小化。反之，默认情况下，是贪婪的（greedy），即匹配次数最大化。</p> <p>举个例子：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;aaabc&quot;</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">a+</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">&quot;d&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// dbc</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;aaabc&quot;</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">a+?</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">&quot;d&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// dddbc</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>在这里我们应该使用非惰性匹配，举个例子：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> str <span class="token operator">=</span> <span class="token string">'&lt;li&gt;&lt;a href=&quot;&lt;%=www.baidu.com%&gt;&quot;&gt;&lt;%=baidu%&gt;&lt;/a&gt;&lt;/li&gt;'</span><span class="token punctuation">;</span>

str<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">&lt;%=(.+?)%&gt;</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">match</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>match<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// &lt;%=www.baidu.com%&gt;</span>
<span class="token comment">// &lt;%=baidu%&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>如果我们使用惰性匹配：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> str <span class="token operator">=</span> <span class="token string">'&lt;li&gt;&lt;a href=&quot;&lt;%=www.baidu.com%&gt;&quot;&gt;&lt;%=baidu%&gt;&lt;/a&gt;&lt;/li&gt;'</span><span class="token punctuation">;</span>

str<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">&lt;%=(.+)%&gt;</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">match</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>match<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// &lt;%=www.baidu.com%&gt;&quot;&gt;&lt;%=baidu%&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h2 id="十-template"><a href="#十-template" class="header-anchor">#</a> 十. template</h2> <p>讲完需要的知识点，我们开始讲 underscore 模板引擎的实现。</p> <p>与我们上篇使用数组的 push ，最后再 join 的方法不同，underscore 使用的是字符串拼接的方式。</p> <p>比如下面这样一段模板字符串：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>&lt;%for ( var i = 0; i &lt; users.length; i++ ) { %&gt;
    &lt;li&gt;
        &lt;a href=&quot;&lt;%=users[i].url%&gt;&quot;&gt;
            &lt;%=users[i].name%&gt;
        &lt;/a&gt;
    &lt;/li&gt;
&lt;% } %&gt;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>我们先将 <code>&lt;%=xxx%&gt;</code> 替换成 <code>'+ xxx +'</code>，再将 <code>&lt;%xxx%&gt;</code> 替换成 <code>'; xxx __p+='</code>:</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>';for ( var i = 0; i &lt; users.length; i++ ) { __p+='
    &lt;li&gt;
        &lt;a href=&quot;'+ users[i].url + '&quot;&gt;
            '+ users[i].name +'
        &lt;/a&gt;
    &lt;/li&gt;
';  } __p+='
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>这段代码肯定会运行错误的，所以我们再添加些头尾代码，然后组成一个完整的代码字符串：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>var __p='';
with(obj){
__p+='

';for ( var i = 0; i &lt; users.length; i++ ) { __p+='
    &lt;li&gt;
        &lt;a href=&quot;'+ users[i].url + '&quot;&gt;
            '+ users[i].name +'
        &lt;/a&gt;
    &lt;/li&gt;
';  } __p+='

';
};
return __p;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>整理下代码就是：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> __p<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">;</span>
<span class="token keyword">with</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">{</span>
    __p<span class="token operator">+=</span><span class="token string">''</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span> <span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> users<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        __p<span class="token operator">+=</span><span class="token string">'&lt;li&gt;&lt;a href=&quot;'</span><span class="token operator">+</span> users<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>url <span class="token operator">+</span> <span class="token string">'&quot;&gt; '</span><span class="token operator">+</span> users<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>name <span class="token operator">+</span><span class="token string">'&lt;/a&gt;&lt;/li&gt;'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    __p<span class="token operator">+=</span><span class="token string">''</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">return</span> __p
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>然后我们将 <code>__p</code> 这段代码字符串传入 Function 构造函数中：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> render <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Function</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> __p<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>我们执行这个 render 函数，传入需要的 data 数据，就可以返回一段 HTML 字符串：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">render</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h2 id="十一-第五版-特殊字符的处理"><a href="#十一-第五版-特殊字符的处理" class="header-anchor">#</a> 十一. 第五版 - 特殊字符的处理</h2> <p>我们接着上篇的 <a href="/《JavaScript》笔记/03.underscore系列/06.underscore系列之实现一个模板引擎-上.html#七-第四版">第四版</a> 进行书写，不过加入对特殊字符的转义以及使用字符串拼接的方式：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 第五版</span>
<span class="token keyword">var</span> settings <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">// 求值</span>
    <span class="token literal-property property">evaluate</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">&lt;%([\s\S]+?)%&gt;</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span>
    <span class="token comment">// 插入</span>
    <span class="token literal-property property">interpolate</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">&lt;%=([\s\S]+?)%&gt;</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> escapes <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string-property property">&quot;'&quot;</span><span class="token operator">:</span> <span class="token string">&quot;'&quot;</span><span class="token punctuation">,</span>
    <span class="token string-property property">'\\'</span><span class="token operator">:</span> <span class="token string">'\\'</span><span class="token punctuation">,</span>
    <span class="token string-property property">'\r'</span><span class="token operator">:</span> <span class="token string">'r'</span><span class="token punctuation">,</span>
    <span class="token string-property property">'\n'</span><span class="token operator">:</span> <span class="token string">'n'</span><span class="token punctuation">,</span>
    <span class="token string-property property">'\u2028'</span><span class="token operator">:</span> <span class="token string">'u2028'</span><span class="token punctuation">,</span>
    <span class="token string-property property">'\u2029'</span><span class="token operator">:</span> <span class="token string">'u2029'</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> escapeRegExp <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\\|'|\r|\n|\u2028|\u2029</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">;</span>

<span class="token keyword">var</span> <span class="token function-variable function">template</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">text</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token keyword">var</span> source <span class="token operator">=</span> <span class="token string">&quot;var __p='';\n&quot;</span><span class="token punctuation">;</span>
    source <span class="token operator">=</span> source <span class="token operator">+</span> <span class="token string">&quot;with(obj){\n&quot;</span>
    source <span class="token operator">=</span> source <span class="token operator">+</span> <span class="token string">&quot;__p+='&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">var</span> main <span class="token operator">=</span> text
    <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>escapeRegExp<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">match</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">'\\'</span> <span class="token operator">+</span> escapes<span class="token punctuation">[</span>match<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>settings<span class="token punctuation">.</span>interpolate<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">match<span class="token punctuation">,</span> interpolate</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;'+\n&quot;</span> <span class="token operator">+</span> interpolate <span class="token operator">+</span> <span class="token string">&quot;+\n'&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>settings<span class="token punctuation">.</span>evaluate<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">match<span class="token punctuation">,</span> evaluate</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;';\n &quot;</span> <span class="token operator">+</span> evaluate <span class="token operator">+</span> <span class="token string">&quot;\n__p+='&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    source <span class="token operator">=</span> source <span class="token operator">+</span> main <span class="token operator">+</span> <span class="token string">&quot;';\n }; \n return __p;&quot;</span><span class="token punctuation">;</span>

    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span>

    <span class="token keyword">var</span> render <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Function</span><span class="token punctuation">(</span><span class="token string">'obj'</span><span class="token punctuation">,</span>  source<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> render<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br></div></div><h2 id="十二-第六版-特殊值的处理"><a href="#十二-第六版-特殊值的处理" class="header-anchor">#</a> 十二. 第六版 - 特殊值的处理</h2> <p>不过有一点需要注意的是：</p> <p>如果数据中 <code>users[i].url</code> 不存在怎么办？此时取值的结果为 undefined，我们知道：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token string">'1'</span> <span class="token operator">+</span> <span class="token keyword">undefined</span> <span class="token comment">// &quot;1undefined&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>就相当于拼接了 undefined 字符串，这肯定不是我们想要的。我们可以在代码中加入一点判断：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>settings<span class="token punctuation">.</span>interpolate<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">match<span class="token punctuation">,</span> interpolate</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">&quot;'+\n&quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span>interpolate <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token string">''</span> <span class="token operator">:</span> interpolate<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;+\n'&quot;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>但是吧，我就是不喜欢写两遍 interpolate …… 嗯？那就这样吧：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> source <span class="token operator">=</span> <span class="token string">&quot;var __t, __p='';\n&quot;</span><span class="token punctuation">;</span>

<span class="token operator">...</span>

<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>settings<span class="token punctuation">.</span>interpolate<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">match<span class="token punctuation">,</span> interpolate</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">&quot;'+\n((__t=(&quot;</span> <span class="token operator">+</span> interpolate <span class="token operator">+</span> <span class="token string">&quot;))==null?'':__t)+\n'&quot;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>其实就相当于：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> __t<span class="token punctuation">;</span>

<span class="token keyword">var</span> result <span class="token operator">=</span> <span class="token punctuation">(</span>__t <span class="token operator">=</span> interpolate<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token string">''</span> <span class="token operator">:</span> __t<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h2 id="十三-第七版"><a href="#十三-第七版" class="header-anchor">#</a> 十三. 第七版</h2> <p>现在我们使用的方式是将模板字符串进行多次替换，然而在 underscore 的实现中，只进行了一次替换，我们来看看 underscore 是怎么实现的：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> <span class="token function-variable function">template</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">text</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> matcher <span class="token operator">=</span> <span class="token function">RegExp</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
        <span class="token punctuation">(</span>settings<span class="token punctuation">.</span>interpolate<span class="token punctuation">)</span><span class="token punctuation">.</span>source<span class="token punctuation">,</span>
        <span class="token punctuation">(</span>settings<span class="token punctuation">.</span>evaluate<span class="token punctuation">)</span><span class="token punctuation">.</span>source
    <span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'|'</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'|$'</span><span class="token punctuation">,</span> <span class="token string">'g'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">var</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> source <span class="token operator">=</span> <span class="token string">&quot;__p+='&quot;</span><span class="token punctuation">;</span>

    text<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>matcher<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">match<span class="token punctuation">,</span> interpolate<span class="token punctuation">,</span> evaluate<span class="token punctuation">,</span> offset</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        source <span class="token operator">+=</span> text<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> offset<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>escapeRegExp<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">match</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token string">'\\'</span> <span class="token operator">+</span> escapes<span class="token punctuation">[</span>match<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        index <span class="token operator">=</span> offset <span class="token operator">+</span> match<span class="token punctuation">.</span>length<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>interpolate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            source <span class="token operator">+=</span> <span class="token string">&quot;'+\n((__t=(&quot;</span> <span class="token operator">+</span> interpolate <span class="token operator">+</span> <span class="token string">&quot;))==null?'':__t)+\n'&quot;</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>evaluate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            source <span class="token operator">+=</span> <span class="token string">&quot;';\n&quot;</span> <span class="token operator">+</span> evaluate <span class="token operator">+</span> <span class="token string">&quot;\n__p+='&quot;</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> match<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    source <span class="token operator">+=</span> <span class="token string">&quot;';\n&quot;</span><span class="token punctuation">;</span>

    source <span class="token operator">=</span> <span class="token string">'with(obj||{}){\n'</span> <span class="token operator">+</span> source <span class="token operator">+</span> <span class="token string">'}\n'</span>

    source <span class="token operator">=</span> <span class="token string">&quot;var __t, __p='';&quot;</span> <span class="token operator">+</span>
        source <span class="token operator">+</span> <span class="token string">'return __p;\n'</span><span class="token punctuation">;</span>

    <span class="token keyword">var</span> render <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Function</span><span class="token punctuation">(</span><span class="token string">'obj'</span><span class="token punctuation">,</span> source<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> render<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br></div></div><p>其实原理也很简单，就是在执行多次匹配函数的时候，不断复制字符串，处理字符串，拼接字符串，最后拼接首尾代码，得到最终的代码字符串。</p> <p>不过值得一提的是：在这段代码里，matcher 的表达式最后为：<code>/&lt;%=([\s\S]+?)%&gt;|&lt;%([\s\S]+?)%&gt;|$/g</code></p> <p>问题是为什么还要加个 <code>|$</code> 呢？我们来看下 $：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> str <span class="token operator">=</span> <span class="token string">&quot;abc&quot;</span><span class="token punctuation">;</span>
str<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">$</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">match<span class="token punctuation">,</span> offset</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> match<span class="token punctuation">)</span> <span class="token comment">// 空字符串</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>offset<span class="token punctuation">)</span> <span class="token comment">// 3</span>
    <span class="token keyword">return</span> match
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>我们之所以匹配 $，是为了获取最后一个字符串的位置，这样当我们 text.slice(index, offset)的时候，就可以截取到最后一个字符。</p> <h2 id="十四-最终版"><a href="#十四-最终版" class="header-anchor">#</a> 十四. 最终版</h2> <p>其实代码写到这里，就已经跟 underscore 的实现很接近了，只是 underscore 加入了更多细节的处理，比如：</p> <ol><li>对数据的转义功能</li> <li>可传入配置项</li> <li>对错误的处理</li> <li>添加 source 属性，以方便查看代码字符串</li> <li>添加了方便调试的 print 函数</li> <li>...</li></ol> <p>但是这些内容都还算简单，就不一版一版写了，</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">/**
 * 模板引擎第八版
 */</span>
<span class="token keyword">var</span> _ <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

_<span class="token punctuation">.</span>templateSettings <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">// 求值</span>
    <span class="token literal-property property">evaluate</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">&lt;%([\s\S]+?)%&gt;</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span>
    <span class="token comment">// 插入</span>
    <span class="token literal-property property">interpolate</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">&lt;%=([\s\S]+?)%&gt;</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span>
    <span class="token comment">// 转义</span>
    <span class="token literal-property property">escape</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">&lt;%-([\s\S]+?)%&gt;</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> noMatch <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">(.)^</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">;</span>

<span class="token keyword">var</span> escapes <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string-property property">&quot;'&quot;</span><span class="token operator">:</span> <span class="token string">&quot;'&quot;</span><span class="token punctuation">,</span>
    <span class="token string-property property">'\\'</span><span class="token operator">:</span> <span class="token string">'\\'</span><span class="token punctuation">,</span>
    <span class="token string-property property">'\r'</span><span class="token operator">:</span> <span class="token string">'r'</span><span class="token punctuation">,</span>
    <span class="token string-property property">'\n'</span><span class="token operator">:</span> <span class="token string">'n'</span><span class="token punctuation">,</span>
    <span class="token string-property property">'\u2028'</span><span class="token operator">:</span> <span class="token string">'u2028'</span><span class="token punctuation">,</span>
    <span class="token string-property property">'\u2029'</span><span class="token operator">:</span> <span class="token string">'u2029'</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> escapeRegExp <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\\|'|\r|\n|\u2028|\u2029</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">;</span>

<span class="token keyword">var</span> <span class="token function-variable function">escapeChar</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">match</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">'\\'</span> <span class="token operator">+</span> escapes<span class="token punctuation">[</span>match<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

_<span class="token punctuation">.</span><span class="token function-variable function">template</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">text<span class="token punctuation">,</span> settings</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    settings <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> _<span class="token punctuation">.</span>templateSettings<span class="token punctuation">,</span> settings<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">var</span> matcher <span class="token operator">=</span> <span class="token function">RegExp</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
        <span class="token punctuation">(</span>settings<span class="token punctuation">.</span>escape <span class="token operator">||</span> noMatch<span class="token punctuation">)</span><span class="token punctuation">.</span>source<span class="token punctuation">,</span>
        <span class="token punctuation">(</span>settings<span class="token punctuation">.</span>interpolate <span class="token operator">||</span> noMatch<span class="token punctuation">)</span><span class="token punctuation">.</span>source<span class="token punctuation">,</span>
        <span class="token punctuation">(</span>settings<span class="token punctuation">.</span>evaluate <span class="token operator">||</span> noMatch<span class="token punctuation">)</span><span class="token punctuation">.</span>source
    <span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'|'</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'|$'</span><span class="token punctuation">,</span> <span class="token string">'g'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">var</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> source <span class="token operator">=</span> <span class="token string">&quot;__p+='&quot;</span><span class="token punctuation">;</span>
    text<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>matcher<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">match<span class="token punctuation">,</span> escape<span class="token punctuation">,</span> interpolate<span class="token punctuation">,</span> evaluate<span class="token punctuation">,</span> offset</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        source <span class="token operator">+=</span> text<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> offset<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>escapeRegExp<span class="token punctuation">,</span> escapeChar<span class="token punctuation">)</span><span class="token punctuation">;</span>

        index <span class="token operator">=</span> offset <span class="token operator">+</span> match<span class="token punctuation">.</span>length<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>escape<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            source <span class="token operator">+=</span> <span class="token string">&quot;'+\n((__t=(&quot;</span> <span class="token operator">+</span> escape <span class="token operator">+</span> <span class="token string">&quot;))==null?'':_.escape(__t))+\n'&quot;</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>interpolate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            source <span class="token operator">+=</span> <span class="token string">&quot;'+\n((__t=(&quot;</span> <span class="token operator">+</span> interpolate <span class="token operator">+</span> <span class="token string">&quot;))==null?'':__t)+\n'&quot;</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>evaluate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            source <span class="token operator">+=</span> <span class="token string">&quot;';\n&quot;</span> <span class="token operator">+</span> evaluate <span class="token operator">+</span> <span class="token string">&quot;\n__p+='&quot;</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> match<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    source <span class="token operator">+=</span> <span class="token string">&quot;';\n&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>settings<span class="token punctuation">.</span>variable<span class="token punctuation">)</span> source <span class="token operator">=</span> <span class="token string">'with(obj||{}){\n'</span> <span class="token operator">+</span> source <span class="token operator">+</span> <span class="token string">'}\n'</span><span class="token punctuation">;</span>

    source <span class="token operator">=</span> <span class="token string">&quot;var __t,__p='',__j=Array.prototype.join,&quot;</span> <span class="token operator">+</span>
        <span class="token string">&quot;print=function(){__p+=__j.call(arguments,'');};\n&quot;</span> <span class="token operator">+</span>
        source <span class="token operator">+</span> <span class="token string">'return __p;\n'</span><span class="token punctuation">;</span>

    <span class="token keyword">var</span> render<span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        render <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Function</span><span class="token punctuation">(</span>settings<span class="token punctuation">.</span>variable <span class="token operator">||</span> <span class="token string">'obj'</span><span class="token punctuation">,</span> <span class="token string">'_'</span><span class="token punctuation">,</span> source<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        e<span class="token punctuation">.</span>source <span class="token operator">=</span> source<span class="token punctuation">;</span>
        <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">var</span> <span class="token function-variable function">template</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">render</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> data<span class="token punctuation">,</span> _<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">var</span> argument <span class="token operator">=</span> settings<span class="token punctuation">.</span>variable <span class="token operator">||</span> <span class="token string">'obj'</span><span class="token punctuation">;</span>
    template<span class="token punctuation">.</span>source <span class="token operator">=</span> <span class="token string">'function('</span> <span class="token operator">+</span> argument <span class="token operator">+</span> <span class="token string">'){\n'</span> <span class="token operator">+</span> source <span class="token operator">+</span> <span class="token string">'}'</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> template<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> results <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;container&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> data <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">users</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span> <span class="token string-property property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Byron&quot;</span><span class="token punctuation">,</span> <span class="token string-property property">&quot;url&quot;</span><span class="token operator">:</span> <span class="token string">&quot;http://localhost&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span> <span class="token string-property property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Casper&quot;</span><span class="token punctuation">,</span> <span class="token string-property property">&quot;url&quot;</span><span class="token operator">:</span> <span class="token string">&quot;http://localhost&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span> <span class="token string-property property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Frank&quot;</span><span class="token punctuation">,</span> <span class="token string-property property">&quot;url&quot;</span><span class="token operator">:</span> <span class="token string">&quot;http://localhost&quot;</span> <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> text <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;user_tmpl&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerHTML
<span class="token keyword">var</span> compiled <span class="token operator">=</span> _<span class="token punctuation">.</span><span class="token function">template</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>compiled<span class="token punctuation">.</span>source<span class="token punctuation">)</span>
results<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token function">compiled</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br></div></div></div></div> <!----> <div class="page-edit"><!----> <div class="tags"><a href="/tags/?tag=JavaScript%20underscore" title="标签">#JavaScript underscore</a></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2022/07/01, 17:34:19</span></div></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/pages/5d25f3/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">underscore 系列之实现一个模板引擎(上)</div></a> <a href="/pages/f7e68a/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">underscore 系列之字符实体与 _.escape</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/pages/5d25f3/" class="prev">underscore 系列之实现一个模板引擎(上)</a></span> <span class="next"><a href="/pages/f7e68a/">underscore 系列之字符实体与 _.escape</a>→
      </span></p></div></div></div> <!----></main></div> <div class="footer"><div class="icons"></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2017-2023
    <span>Jamey | blog <a href="http://beian.miit.gov.cn/" target="_blank">闽ICP备19022664号 </a></span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"><div></div></div></div>
    <script src="/assets/js/app.8146073e.js" defer></script><script src="/assets/js/2.53e9b62d.js" defer></script><script src="/assets/js/143.3cd454d5.js" defer></script><script src="/assets/js/4.49cfce35.js" defer></script>
  </body>
</html>
